FROM ruby:3.4.5-slim

# Install essential Linux packages and retry on failure
RUN apt-get update -qq && \
    for i in {1..3}; do \
    apt-get install -y \
    build-essential \
    libpq-dev \
    postgresql-client \
    wget \
    gnupg \
    chromium \
    chromium-driver && break || sleep 15; \
    done

# Install dependencies required for certain gems
RUN apt-get install -y \
    libssl-dev \
    libreadline-dev \
    zlib1g-dev

# Set up your application
WORKDIR /app
COPY Gemfile Gemfile.lock ./



# Install bundler and gems with retry mechanism
RUN gem install bundler && \
    for i in {1..3}; do \
    # Use following line to build production image
    #        bundle config set --local without 'development test' && \
    bundle install && break || sleep 15; \
    done

# --- NEW STEPS TO ADDRESS REXML WARNING ---
# Update RubyGems itself within the container's environment
# Then, explicitly update and clean up the rexml gem
RUN gem update --system && \
    gem update rexml && \
    gem cleanup rexml
# --- END NEW STEPS ---

COPY . .

RUN groupadd -r chrome && useradd -r -g chrome -G audio,video chrome

# --- DEBUGGING START ---
RUN echo "--- DEBUG: Permissions before chown /usr/local/bundle ---"
RUN ls -la /usr/local/bundle
RUN ls -la /usr/local/bundle/gems
# --- DEBUGGING END ---

# Change ownership of the global gem installation directory so 'chrome' can write to it
RUN chown -R chrome:chrome /usr/local/bundle

# --- DEBUGGING START ---
RUN echo "--- DEBUG: Permissions AFTER chown /usr/local/bundle ---"
RUN ls -la /usr/local/bundle
RUN ls -la /usr/local/bundle/gems
# --- DEBUGGING END ---

    
RUN mkdir -p /app/db_dump && chown -R chrome:chrome /app/db_dump
RUN mkdir -p /home/chrome/.cache/selenium && chown -R chrome:chrome /home/chrome
USER chrome

# Check for download folder
RUN echo "** Download location is set in the project .env file. ***"

CMD ["ruby", "nls_bard.rb", "-h"]
